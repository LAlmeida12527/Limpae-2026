<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Limpa√™ ‚Äî Denunciar (Prot√≥tipo Escolar)</title>

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --green-700:#14532d;
      --green-600:#15803d;
      --accent:#f59e0b;
      --bg:#f6fffa;
      --card:#ffffff;
      --muted:#6b7280;
      --max-width:1180px;
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:14px;
      --shadow: 0 20px 40px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased;}
    body{ background:linear-gradient(180deg,#f1fff7,#f6fffa); color:#102; padding-top:var(--safe-top); line-height:1.45; }

    .container{max-width:var(--max-width); margin:0 auto; padding:18px;}

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo { font-family:"Cinzel Decorative", serif; font-size:22px; color:var(--green-700); -webkit-background-clip:text; }
    .badge{ background:#fff; padding:6px 10px; border-radius:10px; box-shadow:0 8px 24px rgba(2,6,23,0.04); color:var(--green-700); font-weight:700; }

    h1.page-title{ margin:6px 0 2px; font-size:20px; color:var(--green-700); font-family:"Cinzel Decorative",serif; }
    .note{ color:var(--muted); margin-bottom:10px; }

    .grid{ display:grid; grid-template-columns: 1fr 420px; gap:22px; align-items:start; margin-top:12px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); border:1px solid rgba(2,6,23,0.04); }

    /* Stepper */
    .steps{ display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    .step{ background:rgba(20,83,45,0.06); color:var(--green-700); padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px; }
    .progress{ height:8px; background:#eef7ef; border-radius:999px; overflow:hidden; margin-top:10px; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--green-600),var(--green-700)); width:0%; transition:width .28s ease; }

    label{ display:block; font-weight:700; margin-bottom:6px; color:#234; font-size:14px; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea {
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e6eee6; font-size:15px; background:#fff;
    }
    textarea{ min-height:130px; resize:vertical; }

    .row{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .col{ flex:1 1 200px; min-width:0; }

    .muted{ color:var(--muted); font-size:13px; }

    /* Map & geosearch */
    .geo-search{ display:flex; gap:8px; align-items:center; margin-top:6px; }
    .geo-search input{ flex:1; padding:12px 14px; border-radius:10px; border:1px solid #e6eee6; }
    .geo-list{ position: absolute; left:0; right:0; margin-top:8px; background:#fff; border-radius:8px; box-shadow:0 12px 32px rgba(2,6,23,0.08); max-height:240px; overflow:auto; z-index:1200; border:1px solid rgba(2,6,23,0.04); }
    .geo-item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(2,6,23,0.03); }
    .geo-item:hover{ background:#f3faf4; }

    #map{ width:100%; height:360px; border-radius:12px; border:1px solid rgba(2,6,23,0.06); margin-top:10px; }

    /* Photos */
    .photos{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .photo-thumb{ width:120px; height:96px; object-fit:cover; border-radius:8px; border:1px solid rgba(2,6,23,0.06); box-shadow:0 8px 18px rgba(2,6,23,0.04); }

    /* actions */
    .step-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
    .btn{ background:linear-gradient(90deg,var(--green-600),var(--green-700)); color:#fff; padding:12px 16px; border-radius:10px; border:0; font-weight:800; cursor:pointer; box-shadow:0 12px 30px rgba(20,83,45,0.12); }
    .btn.ghost{ background:transparent; color:#475569; border:1px solid rgba(20,83,45,0.06); box-shadow:none; font-weight:700; }

    /* preview side */
    .preview .meta{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .report-card{ padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfff9); border:1px solid rgba(34,197,94,0.06); }

    .saved-list{ display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; margin-top:10px; padding-right:6px; }

    footer{ margin-top:22px; text-align:center; color:var(--muted); font-size:13px; }

    /* mobile bar for next/back */
    .mobile-bottom{ display:none; position:fixed; left:0; right:0; bottom:0; padding:12px; background:#fff; box-shadow:0 -8px 30px rgba(2,6,23,0.08); z-index:9999; gap:10px; justify-content:space-between; align-items:center; }
    @media (max-width:720px){ .mobile-bottom{ display:flex; } body{ padding-bottom:90px; } }
  </style>
</head>
<body>
  <header class="container">
    <div class="brand">
      <div class="logo">Limpa√™</div>
      <div class="badge">Projeto Escolar</div>
    </div>
    <nav><a href="index.html" style="text-decoration:none;color:#234;font-weight:700">In√≠cio</a></nav>
  </header>

  <main class="container">
    <h1 class="page-title">Formul√°rio de den√∫ncia (simula√ß√£o)</h1>
    <div class="note">Use apenas para fins educacionais. Os envios s√£o simulados ‚Äî localmente armazenados e encaminhados para demonstra√ß√£o.</div>

    <div class="grid" role="region" aria-label="Formul√°rio de den√∫ncia">
      <!-- LEFT: Form -->
      <div class="card" id="form-panel">
        <div class="steps" aria-hidden="false">
          <div class="step">1. Categoria</div>
          <div class="step">2. Local</div>
          <div class="step">3. Fotos</div>
          <div class="step">4. Revisar</div>
        </div>
        <div class="progress" aria-hidden="true"><i id="progress-bar" style="width:0%"></i></div>

        <form id="report-form" action="https://formsubmit.co/limpaemanut@gmail.com" method="POST" enctype="multipart/form-data" autocomplete="off" novalidate>
          <input type="hidden" name="_subject" value="Den√∫ncia simulada ‚Äî Limpa√™">
          <input type="hidden" name="_captcha" value="false">
          <input type="hidden" name="source" value="limpae-prototipo-escolar">
          <input type="hidden" name="photos_data" id="photos-data">

          <!-- STEP 1 -->
          <fieldset data-step="1">
            <div class="row">
              <div class="col">
                <label for="category">Categoria *</label>
                <select id="category" name="category" required>
                  <option value="">Escolha...</option>
                  <option value="residencial">Descarte residencial</option>
                  <option value="comercial">Descarte comercial</option>
                  <option value="entulho">Entulho / Constru√ß√£o</option>
                  <option value="eletronico">Res√≠duo eletr√¥nico</option>
                  <option value="verde">Restos de poda / vegeta√ß√£o</option>
                  <option value="outro">Outro</option>
                </select>
              </div>

              <div class="col">
                <label for="severity">Gravidade *</label>
                <select id="severity" name="severity" required>
                  <option value="">Selecione</option>
                  <option value="baixo">Baixo ‚Äî lixo solto</option>
                  <option value="medio">M√©dio ‚Äî ac√∫mulo</option>
                  <option value="alto">Alto ‚Äî grande ac√∫mulo/entulho</option>
                  <option value="critico">Cr√≠tico ‚Äî risco √† sa√∫de</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px">
              <label for="description">Descri√ß√£o detalhada *</label>
              <textarea id="description" name="description" placeholder="Descreva o local, quantidade, caracter√≠sticas (ex.: presen√ßa de vidro, produtos qu√≠micos), riscos"></textarea>
              <div class="muted" style="margin-top:6px">Dica: informe pontos de refer√™ncia (quadra, esquina, n√∫mero) e qualquer risco imediato.</div>
            </div>

            <div style="margin-top:12px" class="row">
              <div class="col">
                <label for="datetime">Data / hora observada</label>
                <input id="datetime" name="datetime" type="datetime-local">
              </div>
              <div class="col">
                <label for="reported-by">Seu nome (opcional)</label>
                <input id="reported-by" name="reported_by" type="text" placeholder="Nome (opcional)">
              </div>
            </div>

            <div style="margin-top:10px" class="row">
              <div class="col">
                <label for="contact">Contato (opcional)</label>
                <input id="contact" name="contact" type="text" placeholder="Telefone ou e‚Äëmail (opcional)">
              </div>
              <div class="col">
                <label for="est-volume">Estimativa de volume</label>
                <select id="est-volume" name="est_volume">
                  <option value="">---</option>
                  <option value="pouco">Pouco (sacola / pequeno)</option>
                  <option value="medio">M√©dio (m√∫ltiplas sacolas)</option>
                  <option value="muito">Muito (carga, entulho grande)</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Riscos / Observa√ß√µes r√°pidas</label>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <label style="font-weight:600"><input type="checkbox" id="risk-animals"> Animais</label>
                <label style="font-weight:600"><input type="checkbox" id="risk-fire"> Risco de fogo</label>
                <label style="font-weight:600"><input type="checkbox" id="risk-chemical"> Produtos qu√≠micos</label>
                <label style="font-weight:600"><input type="checkbox" id="risk-health"> Risco √† sa√∫de</label>
              </div>
            </div>

            <div class="step-actions">
              <button type="button" class="btn" id="next-1">Pr√≥ximo</button>
            </div>
          </fieldset>

          <!-- STEP 2: location with Brazil-only geosearch -->
          <fieldset data-step="2" style="display:none">
            <label class="">Localiza√ß√£o</label>

            <div class="geo-search" style="position:relative;">
              <input id="geo-input" placeholder="Pesquisar endere√ßo (apenas Brasil) ‚Äî ex.: Avenida Paulista, S√£o Paulo" aria-label="Pesquisar local">
              <button type="button" id="geo-clear" class="btn ghost" style="padding:10px 12px">‚úï</button>
              <div id="geo-list" class="geo-list" style="display:none"></div>
            </div>

            <div id="map" aria-label="Mapa"></div>

            <div style="margin-top:12px" class="row">
              <div class="col">
                <label for="address">Endere√ßo / refer√™ncia</label>
                <input id="address" name="address" type="text" placeholder="Ex.: Rua X, pr√≥ximo ao n√∫mero Y">
              </div>
              <div style="min-width:150px">
                <label>Coordenadas</label>
                <div class="muted" style="padding:10px 12px; background:#fbfff9; border-radius:8px; border:1px solid rgba(34,197,94,0.06)">
                  Lat: <span id="lat">‚Äî</span><br>Lng: <span id="lng">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <button type="button" class="btn ghost" id="back-2">Voltar</button>
              <button type="button" class="btn" id="next-2">Pr√≥ximo</button>
            </div>
          </fieldset>

          <!-- STEP 3: photos (with client-side compression) -->
          <fieldset data-step="3" style="display:none">
            <label for="photos">Fotos (at√© 6) ‚Äî recomendamos imagens pequenas</label>
            <input id="photos" type="file" accept="image/*" multiple>
            <div class="muted" style="margin-top:6px">As imagens s√£o redimensionadas no navegador para reduzir tamanho do envio.</div>
            <div class="photos" id="photos-preview" aria-live="polite"></div>

            <div class="step-actions">
              <button type="button" class="btn ghost" id="back-3">Voltar</button>
              <button type="button" class="btn" id="next-3">Pr√≥ximo</button>
            </div>
          </fieldset>

          <!-- STEP 4: review & submit -->
          <fieldset data-step="4" style="display:none">
            <label>Revisar den√∫ncia</label>
            <div id="review-area" class="report-card" aria-live="polite"></div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
              <input id="anonymous" name="anonymous" type="checkbox"> <label for="anonymous" style="margin:0;font-weight:700">Enviar anonimamente (simula√ß√£o)</label>
            </div>

            <div class="step-actions">
              <button type="button" class="btn ghost" id="back-4">Voltar</button>
              <button type="submit" class="btn" id="submit-report">Enviar den√∫ncia</button>
            </div>
          </fieldset>
        </form>
      </div>

      <!-- RIGHT: preview + saved -->
      <aside>
        <div class="card preview">
          <h3 style="margin:0 0 8px">Visualiza√ß√£o r√°pida</h3>
          <div class="report-card">
            <div class="meta">
              <div><strong>Categoria:</strong> <span id="pv-category">‚Äî</span></div>
              <div class="muted" id="pv-severity">‚Äî</div>
            </div>
            <div id="pv-desc" class="muted" style="margin-top:10px">‚Äî</div>
            <div id="pv-photos" style="display:flex;gap:8px;margin-top:10px"></div>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:flex-end;">
            <button class="btn" id="open-review">Ir para revis√£o</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3 style="margin:0 0 8px">Den√∫ncias simuladas (local)</h3>
          <div class="saved-list" id="saved-list"></div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;"><button class="btn ghost" id="clear-storage">Limpar todas</button></div>
        </div>
      </aside>
    </div>

    <footer>Prot√≥tipo escolar ‚Äî uso apenas para demonstra√ß√£o educacional.</footer>
  </main>

  <!-- mobile bottom navigation -->
  <div class="mobile-bottom" id="mobile-bottom" aria-hidden="true">
    <div id="mobile-step" style="font-weight:800;color:#234">Passo</div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" id="mb-back">Voltar</button>
      <button class="btn" id="mb-next">Pr√≥ximo</button>
    </div>
  </div>

  <script>
  // State
  const state = { step:1, lat:null, lng:null, photos: [], map:null, marker:null };

  // Elements
  const form = document.getElementById('report-form');
  const fieldsets = Array.from(form.querySelectorAll('fieldset[data-step]'));
  const progressBar = document.getElementById('progress-bar');

  // Step buttons
  const next1 = document.getElementById('next-1'), next2 = document.getElementById('next-2'), next3 = document.getElementById('next-3');
  const back2 = document.getElementById('back-2'), back3 = document.getElementById('back-3'), back4 = document.getElementById('back-4');
  const openReview = document.getElementById('open-review');
  const submitBtn = document.getElementById('submit-report');

  // Preview elements
  const pvCategory = document.getElementById('pv-category'), pvSeverity = document.getElementById('pv-severity'), pvDesc = document.getElementById('pv-desc'), pvPhotos = document.getElementById('pv-photos');
  const reviewArea = document.getElementById('review-area');

  // Map and geo search
  const geoInput = document.getElementById('geo-input'), geoList = document.getElementById('geo-list'), geoClear = document.getElementById('geo-clear');
  const addressEl = document.getElementById('address'), latEl = document.getElementById('lat'), lngEl = document.getElementById('lng');

  // Photos
  const photosInput = document.getElementById('photos'), photosPreview = document.getElementById('photos-preview'), photosDataInput = document.getElementById('photos-data');

  // Saved reports
  const savedList = document.getElementById('saved-list'), clearStorageBtn = document.getElementById('clear-storage');

  // Mobile controls
  const mobileBottom = document.getElementById('mobile-bottom'), mbBack = document.getElementById('mb-back'), mbNext = document.getElementById('mb-next'), mobileStep = document.getElementById('mobile-step');

  // Utility: show step
  function showStep(n){
    state.step = n;
    fieldsets.forEach(fs => fs.style.display = Number(fs.dataset.step) === n ? '' : 'none');
    updateProgress();
    updatePreview();
    updateMobileBar();
    if(n === 2) initMapOnce();
    if(state.map) setTimeout(()=> state.map.invalidateSize(), 150);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function updateProgress(){
    const percent = (state.step - 1) / (fieldsets.length - 1) * 100;
    progressBar.style.width = percent + '%';
  }

  function updatePreview(){
    const cat = document.getElementById('category').value || '‚Äî';
    const sev = document.getElementById('severity').value || '‚Äî';
    const desc = document.getElementById('description').value || '‚Äî';
    pvCategory.textContent = cat;
    pvSeverity.textContent = sev;
    pvDesc.textContent = desc;
    pvPhotos.innerHTML = '';
    state.photos.slice(0,4).forEach(url => {
      const img = document.createElement('img'); img.src = url; img.className = 'photo-thumb'; pvPhotos.appendChild(img);
    });
  }

  // STEP navigation
  next1.addEventListener('click', ()=> { if(validateStep1()) showStep(2); });
  back2.addEventListener('click', ()=> showStep(1));
  next2.addEventListener('click', ()=> showStep(3));
  back3.addEventListener('click', ()=> showStep(2));
  next3.addEventListener('click', ()=> { populateReview(); showStep(4); });
  back4.addEventListener('click', ()=> showStep(3));
  openReview.addEventListener('click', ()=> { if(validateStep1()){ populateReview(); showStep(4); } else showStep(1); });

  // Mobile bar
  function updateMobileBar(){
    if(window.innerWidth > 720){ mobileBottom.style.display = 'none'; mobileBottom.setAttribute('aria-hidden','true'); return; }
    mobileBottom.style.display = 'flex'; mobileBottom.setAttribute('aria-hidden','false');
    mobileStep.textContent = `Passo ${state.step} de ${fieldsets.length}`;
    mbBack.style.display = state.step === 1 ? 'none' : 'inline-flex';
    mbNext.style.display = state.step === fieldsets.length ? 'none' : 'inline-flex';
  }
  mbBack.addEventListener('click', ()=> { if(state.step>1) showStep(state.step-1); });
  mbNext.addEventListener('click', ()=> {
    if(state.step === 1){ if(validateStep1()) showStep(2); }
    else if(state.step === 2) showStep(3);
    else if(state.step === 3){ populateReview(); showStep(4); }
  });
  window.addEventListener('resize', updateMobileBar);

  function validateStep1(){
    const cat = document.getElementById('category').value;
    const sev = document.getElementById('severity').value;
    const desc = document.getElementById('description').value.trim();
    if(!cat || !sev || !desc){ alert('Preencha categoria, gravidade e descri√ß√£o.'); return false; }
    return true;
  }

  // ---------- MAP & GEOSEARCH (Brazil-only) ----------
  function initMapOnce(){
    if(state.map) return;
    const mapEl = document.getElementById('map');
    state.map = L.map(mapEl, { scrollWheelZoom:false }).setView([-15.7801, -47.9292], 4); // Brazil center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(state.map);
    state.marker = L.marker([-15.7801, -47.9292], { draggable:true }).addTo(state.map);
    state.marker.on('dragend', function(e){
      const p = e.target.getLatLng(); state.lat = p.lat; state.lng = p.lng;
      latEl.textContent = state.lat.toFixed(6); lngEl.textContent = state.lng.toFixed(6);
    });
  }

  document.getElementById('detect-location')?.addEventListener('click', function(){
    if(!navigator.geolocation){ alert('Geolocaliza√ß√£o n√£o suportada no navegador.'); return; }
    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){ if(!confirm('Geolocaliza√ß√£o funciona melhor em HTTPS. Tentar mesmo assim?')) return; }
    this.textContent = 'Detectando‚Ä¶';
    navigator.geolocation.getCurrentPosition(pos=>{
      this.textContent = 'Detectar minha posi√ß√£o';
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      state.lat = lat; state.lng = lng; latEl.textContent = lat.toFixed(6); lngEl.textContent = lng.toFixed(6);
      if(!state.map) initMapOnce();
      state.map.setView([lat,lng], 16); state.marker.setLatLng([lat,lng]);
      addressEl.value = '';
    }, err=>{
      this.textContent = 'Detectar minha posi√ß√£o';
      alert('N√£o foi poss√≠vel obter a localiza√ß√£o: ' + (err.message || 'erro'));
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
  });

  // Nominatim search restricted to BRA (countrycodes=br)
  let geoTimer = null;
  geoInput.addEventListener('input', function(){
    const q = this.value.trim();
    geoList.style.display = 'none'; geoList.innerHTML = '';
    if(geoTimer) clearTimeout(geoTimer);
    if(!q) return;
    geoTimer = setTimeout(()=> nominatimSearch(q), 350);
  });

  geoClear.addEventListener('click', ()=> { geoInput.value=''; geoList.innerHTML=''; geoList.style.display='none'; });

  async function nominatimSearch(query){
    geoList.innerHTML = '<div style="padding:10px;color:#6b7280">Buscando...</div>'; geoList.style.display = 'block';
    try{
      const url = 'https://nominatim.openstreetmap.org/search?format=json&countrycodes=br&limit=8&q=' + encodeURIComponent(query);
      const res = await fetch(url, { headers: { 'Accept-Language': 'pt-BR' }});
      const data = await res.json();
      if(!data || !data.length){ geoList.innerHTML = '<div style="padding:10px;color:#6b7280">Nenhum resultado</div>'; return; }
      geoList.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div'); div.className = 'geo-item';
        div.textContent = item.display_name;
        div.addEventListener('click', ()=> {
          if(!state.map) initMapOnce();
          const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
          state.map.setView([lat, lon], 16);
          state.marker.setLatLng([lat, lon]);
          state.lat = lat; state.lng = lon;
          latEl.textContent = lat.toFixed(6); lngEl.textContent = lon.toFixed(6);
          addressEl.value = item.display_name;
          geoInput.value = item.display_name;
          geoList.style.display = 'none';
        });
        geoList.appendChild(div);
      });
    }catch(e){
      geoList.innerHTML = '<div style="padding:10px;color:#b91c1c">Erro na busca</div>';
    }
  }

  // ---------- IMAGE COMPRESSION (client-side) ----------
  photosInput.addEventListener('change', async function(){
    const files = Array.from(this.files).slice(0,6);
    photosPreview.innerHTML = ''; state.photos = [];
    if(!files.length) return;
    for(const file of files){
      try{
        const compressed = await compressImage(file, 1200, 0.75); // max width 1200, quality 0.75
        state.photos.push(compressed);
        const img = document.createElement('img'); img.src = compressed; img.className = 'photo-thumb'; photosPreview.appendChild(img);
        updatePreview();
      }catch(err){
        console.error('compress error', err);
      }
    }
  });

  function compressImage(file, maxWidth=1200, quality=0.75){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = function(){
        const scale = Math.min(1, maxWidth / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        // toDataURL with quality
        canvas.toDataURL('image/jpeg', quality, (/*ignored*/)=>{});
        // Some browsers don't accept callback in toDataURL; use synchronous
        try{
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        }catch(e){
          reject(e);
        }
      };
      img.onerror = reject;
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- Review & submit ----------
  function populateReview(){
    const cat = document.getElementById('category').value || '‚Äî';
    const sev = document.getElementById('severity').value || '‚Äî';
    const desc = document.getElementById('description').value || '‚Äî';
    const addr = addressEl.value || '‚Äî';
    const dt = document.getElementById('datetime') ? document.getElementById('datetime').value : '';
    const photosHtml = state.photos.map(u => `<img src="${u}" style="width:140px;height:110px;object-fit:cover;border-radius:8px;margin-right:8px">`).join('');
    reviewArea.innerHTML = `
      <div><strong>Categoria:</strong> ${escapeHtml(cat)}</div>
      <div><strong>Gravidade:</strong> ${escapeHtml(sev)}</div>
      <div style="margin-top:8px;"><strong>Descri√ß√£o:</strong><div style="margin-top:6px">${escapeHtml(desc)}</div></div>
      <div style="margin-top:8px;"><strong>Local:</strong> ${escapeHtml(addr)} <small style="display:block;color:#6b7280">Lat: ${state.lat||'‚Äî'} Lng: ${state.lng||'‚Äî'}</small></div>
      <div style="margin-top:8px;"><strong>Data/Hora:</strong> ${escapeHtml(dt)}</div>
      <div style="margin-top:12px;"><strong>Fotos:</strong><div style="display:flex;gap:8px;margin-top:8px">${photosHtml || '<span style="color:#6b7280">Sem fotos</span>'}</div></div>
    `;
    photosDataInput.value = JSON.stringify(state.photos);
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Save locally + submit via FormSubmit in new tab
  form.addEventListener('submit', function(ev){
    if(!validateStep1()){ ev.preventDefault(); showStep(1); return; }
    // compose report
    const report = {
      id: 'r' + Date.now(),
      category: document.getElementById('category').value,
      severity: document.getElementById('severity').value,
      description: document.getElementById('description').value,
      datetime: document.getElementById('datetime') ? document.getElementById('datetime').value : '',
      reported_by: document.getElementById('reported-by')?.value || '',
      contact: document.getElementById('contact')?.value || '',
      est_volume: document.getElementById('est-volume')?.value || '',
      hazards: [
        !!document.getElementById('risk-animals')?.checked,
        !!document.getElementById('risk-fire')?.checked,
        !!document.getElementById('risk-chemical')?.checked,
        !!document.getElementById('risk-health')?.checked
      ],
      address: addressEl.value || '',
      lat: state.lat,
      lng: state.lng,
      photos: state.photos.slice(),
      anonymous: document.getElementById('anonymous')?.checked,
      createdAt: new Date().toISOString()
    };
    saveReport(report);
    populateSavedList();
    photosDataInput.value = JSON.stringify(report.photos || []);

    // submit in new tab (temporary form)
    ev.preventDefault();
    const tmp = document.createElement('form'); tmp.method='POST'; tmp.action = form.action; tmp.target='_blank'; tmp.style.display='none';
    const payload = {
      _subject: 'Den√∫ncia simulada ‚Äî Limpa√™', _captcha:'false', source:'limpae-prototipo-escolar',
      category: report.category, severity: report.severity, description: report.description,
      datetime: report.datetime, reported_by: report.reported_by, contact: report.contact,
      est_volume: report.est_volume, address: report.address, lat: report.lat, lng: report.lng,
      anonymous: report.anonymous ? 'Sim' : 'N√£o', photos_data: JSON.stringify(report.photos || [])
    };
    for(const k in payload){ const i = document.createElement('input'); i.type='hidden'; i.name = k; i.value = payload[k] || ''; tmp.appendChild(i); }
    document.body.appendChild(tmp); tmp.submit(); setTimeout(()=>tmp.remove(), 800);

    // feedback & reset
    showThanksLocal();
    form.reset(); state.photos = []; photosPreview.innerHTML = ''; updatePreview();
    state.lat = null; state.lng = null; latEl.textContent='‚Äî'; lngEl.textContent='‚Äî';
    showStep(1);
  });

  // ---------- local storage for saved reports ----------
  function getReports(){ try{ return JSON.parse(localStorage.getItem('limpae_reports')||'[]'); }catch(e){ return []; } }
  function saveReport(r){ const arr = getReports(); arr.unshift(r); localStorage.setItem('limpae_reports', JSON.stringify(arr.slice(0,200))); }
  function populateSavedList(){
    const arr = getReports(); savedList.innerHTML = '';
    if(!arr.length){ savedList.innerHTML = '<div style="color:#6b7280">Nenhuma den√∫ncia simulada ainda.</div>'; return; }
    arr.forEach(item=>{
      const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='8px'; el.style.borderRadius='8px'; el.style.border='1px solid rgba(2,6,23,0.04)'; el.style.background='#fff';
      el.innerHTML = `<div style="display:flex;gap:10px;align-items:center;min-width:0">
        <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center">${item.photos && item.photos[0] ? `<img src="${item.photos[0]}" style="width:56px;height:56px;object-fit:cover">` : 'üóëÔ∏è'}</div>
        <div style="min-width:0">
          <div style="font-weight:700;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:180px">${escapeHtml(item.category)} ¬∑ ${escapeHtml(item.severity)}</div>
          <div class="muted" style="max-width:220px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden">${escapeHtml(item.description)}</div>
          <div class="muted" style="margin-top:4px">${new Date(item.createdAt).toLocaleString()}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button data-id="${item.id}" class="btn ghost view-btn">Ver</button>
        <button data-id="${item.id}" class="btn ghost download-btn">Baixar</button>
        <button data-id="${item.id}" class="remove-btn" style="background:transparent;border:0;color:#ef4444;font-weight:700;cursor:pointer">Remover</button>
      </div>`;
      savedList.appendChild(el);
    });

    // handlers
    Array.from(savedList.querySelectorAll('.remove-btn')).forEach(btn=> btn.addEventListener('click', function(){
      const id = this.dataset.id; const arr = getReports().filter(x=>x.id !== id); localStorage.setItem('limpae_reports', JSON.stringify(arr)); populateSavedList();
    }));
    Array.from(savedList.querySelectorAll('.view-btn')).forEach(btn=> btn.addEventListener('click', function(){
      const id = this.dataset.id; const item = getReports().find(x=>x.id===id); if(!item) return;
      alert(JSON.stringify(item, null, 2)); // simple viewer for prototype
    }));
    Array.from(savedList.querySelectorAll('.download-btn')).forEach(btn => btn.addEventListener('click', function(){
      const id = this.dataset.id; const item = getReports().find(x=>x.id===id); if(!item) return;
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(item, null, 2)], { type: 'application/json' })); a.download = `${id}.json`; document.body.appendChild(a); a.click(); a.remove();
    }));
  }

  clearStorageBtn.addEventListener('click', ()=> { if(confirm('Limpar todas as den√∫ncias simuladas armazenadas localmente?')){ localStorage.removeItem('limpae_reports'); populateSavedList(); } });

  // ---------- keyboard behavior: Enter goes to next step (except textarea) ----------
  form.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      const active = document.activeElement;
      if(active && active.tagName && active.tagName.toLowerCase() === 'textarea') return;
      e.preventDefault();
      if(state.step === 1){ if(validateStep1()) showStep(2); }
      else if(state.step === 2) showStep(3);
      else if(state.step === 3) { populateReview(); showStep(4); }
    }
  });

  // ---------- helpers ----------
  function populateReview(){ updatePreview(); const cat = document.getElementById('category').value || '‚Äî'; const sev = document.getElementById('severity').value || '‚Äî'; const desc = document.getElementById('description').value || '‚Äî'; const addr = addressEl.value || '‚Äî'; const dt = document.getElementById('datetime') ? document.getElementById('datetime').value : ''; const photosHtml = state.photos.map(u => `<img src="${u}" style="width:140px;height:110px;object-fit:cover;border-radius:8px;margin-right:8px">`).join(''); reviewArea.innerHTML = `<div><strong>Categoria:</strong> ${escapeHtml(cat)}</div><div><strong>Gravidade:</strong> ${escapeHtml(sev)}</div><div style="margin-top:8px"><strong>Descri√ß√£o:</strong><div style="margin-top:6px">${escapeHtml(desc)}</div></div><div style="margin-top:8px"><strong>Local:</strong> ${escapeHtml(addr)} <small style="display:block;color:#6b7280">Lat: ${state.lat||'‚Äî'} Lng: ${state.lng||'‚Äî'}</small></div><div style="margin-top:8px"><strong>Data/Hora:</strong> ${escapeHtml(dt)}</div><div style="margin-top:12px"><strong>Fotos:</strong><div style="display:flex;gap:8px;margin-top:8px">${photosHtml || '<span style="color:#6b7280">Sem fotos</span>'}</div></div>`; photosDataInput.value = JSON.stringify(state.photos); }

  function showThanksLocal(){ const el = document.createElement('div'); el.style.position='fixed'; el.style.left='50%'; el.style.top='50%'; el.style.transform='translate(-50%,-50%)'; el.style.zIndex=99999; el.style.background='#fff'; el.style.padding='18px'; el.style.borderRadius='12px'; el.style.boxShadow='0 18px 40px rgba(2,6,23,0.2)'; el.innerHTML = `<h3 style="margin:0 0 8px;color:#14532d">Den√∫ncia simulada enviada</h3><p style="margin:0 0 12px;color:#374151">A den√∫ncia foi salva localmente e uma c√≥pia foi encaminhada (simula√ß√£o).</p><div style="text-align:right"><button id="close-thanks" style="background:linear-gradient(90deg,#15803d,#14532d);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Fechar</button></div>`; document.body.appendChild(el); document.body.style.overflow='hidden'; document.getElementById('close-thanks').addEventListener('click', ()=>{ el.remove(); document.body.style.overflow=''; }); }

  // progress bar init
  updateProgress();

  // init display
  showStep(1);
  populateSavedList();
  updatePreview();
  updateMobileBar();

  // ensure map resizing when visible
  const obs = new MutationObserver(()=>{ if(state.map) state.map.invalidateSize(); });
  obs.observe(document.getElementById('form-panel'), { childList:true, subtree:true });

  // util: small debounce for resize events
  function debounce(fn, wait=100){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
  window.addEventListener('resize', debounce(updateMobileBar, 120));
  function updateMobileBar(){ if(window.innerWidth > 720){ mobileBottom.style.display = 'none'; mobileBottom.setAttribute('aria-hidden','true'); return; } mobileBottom.style.display = 'flex'; mobileBottom.setAttribute('aria-hidden','false'); mobileStep.textContent = `Passo ${state.step} de ${fieldsets.length}`; mbBack.style.display = state.step===1 ? 'none' : 'inline-flex'; mbNext.style.display = state.step===fieldsets.length ? 'none' : 'inline-flex'; }

  // small helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
