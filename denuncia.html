<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Limpa√™ ‚Äî Denunciar (Prot√≥tipo Escolar)</title>

  <!-- Fontes -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Leaflet CSS/JS (no integrity to avoid blocking) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --green-700:#14532d;
      --green-600:#15803d;
      --green-500:#22c55e;
      --safe-top: env(safe-area-inset-top, 0px);
      --glass: rgba(255,255,255,0.9);
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:"Poppins",system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
    body{ padding-top:var(--safe-top); background:linear-gradient(180deg,#f7fff9,#ffffff); color:#1f2937; -webkit-font-smoothing:antialiased; }
    .container{max-width:var(--max-width); margin:0 auto; padding:16px;}

    header{ display:flex; align-items:center; justify-content:space-between; padding:12px 0; }
    .logo { font-family:"Cinzel Decorative", serif; background:linear-gradient(90deg,var(--green-700),var(--green-500)); -webkit-background-clip:text; color:transparent; font-size:24px; }
    .badge { font-size:12px; padding:6px 10px; border-radius:10px; background:var(--glass); color:var(--green-700); font-weight:700; }

    .note { text-align:center; margin:12px 0; font-weight:600; color:#334155; }
    .note small{ display:block; font-weight:500; color:#475569; margin-top:6px; }

    .grid{ display:grid; grid-template-columns:1fr 360px; gap:22px; align-items:start; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:#fff; border-radius:12px; padding:16px; border:1px solid rgba(2,6,23,0.04); box-shadow:0 18px 40px rgba(2,6,23,0.04); }

    label{ display:block; font-weight:700; margin-bottom:6px; color:#263238; font-size:13px; }
    input, select, textarea { width:100%; padding:12px; border-radius:8px; border:1px solid #e6e8eb; font-size:15px; }
    textarea{ min-height:110px; resize:vertical; }

    .controls{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap; }
    .btn{ background:linear-gradient(90deg,var(--green-600),var(--green-500)); color:#fff; padding:12px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:700; }
    .btn.ghost{ background:transparent; color:var(--green-700); border:1px solid rgba(20,83,45,0.08); }

    #map{ width:100%; height:260px; border-radius:10px; border:1px solid rgba(2,6,23,0.06); margin-top:8px; }

    .photos{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .photo-thumb{ width:88px; height:88px; object-fit:cover; border-radius:8px; border:1px solid rgba(2,6,23,0.06); }

    .report-card{ padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfff9); border:1px solid rgba(34,197,94,0.06); }

    .saved-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; }

    /* Mobile bottom actions */
    .step-actions{
      display:none;
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px;
      background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.96));
      box-shadow:0 -10px 30px rgba(2,6,23,0.06);
      z-index:3000;
      gap:10px;
      justify-content:space-between;
    }
    @media(max-width:720px){
      .step-actions{ display:flex; }
      body{ padding-bottom:84px; }
      .btn{ font-size:15px; }
    }
  </style>
</head>
<body>
  <header class="container">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">Limpa√™</div>
      <div class="badge">Projeto Escolar</div>
    </div>
    <nav><a href="index.html" style="text-decoration:none;color:#334155;font-weight:700">In√≠cio</a></nav>
  </header>

  <main class="container" role="main">
    <div class="note">Formul√°rio de den√∫ncia (simulada) ‚Äî uso educacional. <small>N√£o envia dados a √≥rg√£os reais. Tamb√©m envia um e‚Äëmail de demonstra√ß√£o via FormSubmit quando confirmado.</small></div>

    <div class="grid" role="region" aria-label="Formul√°rio de den√∫ncia">
      <div class="card" id="left-card">
        <h2 style="margin:0 0 8px; font-family:'Cinzel Decorative', serif; color:var(--green-700)">Denunciar ponto de descarte</h2>

        <!-- The HTML form will POST to FormSubmit endpoint and also be handled locally by JS -->
        <form id="report-form" method="POST" action="https://formsubmit.co/el/kazoho" enctype="multipart/form-data" novalidate>
          <!-- Hidden fields for FormSubmit -->
          <input type="hidden" name="_subject" value="Nova den√∫ncia simulada ‚Äî Limpa√™" />
          <input type="hidden" name="_captcha" value="false" />
          <input type="hidden" name="_next" value="https://formsubmit.co/thankyou" />
          <!-- include an identifier so you can filter simulated emails -->
          <input type="hidden" name="source" value="limpae-prototipo-escolar" />

          <!-- Step 1 -->
          <fieldset data-step="1">
            <label for="category">Categoria *</label>
            <select id="category" name="category" required>
              <option value="">Escolha a categoria...</option>
              <option value="residencial">Descarte residencial</option>
              <option value="comercial">Descarte comercial</option>
              <option value="entulho">Entulho / Constru√ß√£o</option>
              <option value="eletronico">Res√≠duo eletr√¥nico</option>
              <option value="verde">Restos de poda / vegeta√ß√£o</option>
              <option value="outro">Outro</option>
            </select>

            <label for="severity" style="margin-top:10px">Gravidade *</label>
            <select id="severity" name="severity" required>
              <option value="">Selecione</option>
              <option value="baixo">Baixo ‚Äî lixo solto</option>
              <option value="medio">M√©dio ‚Äî ac√∫mulo pequeno</option>
              <option value="alto">Alto ‚Äî grande ac√∫mulo/entulho</option>
              <option value="critico">Cr√≠tico ‚Äî risco √† sa√∫de</option>
            </select>

            <label for="description" style="margin-top:10px">Descri√ß√£o *</label>
            <textarea id="description" name="description" placeholder="Descreva o local e observa√ß√µes" required></textarea>

            <label for="datetime" style="margin-top:10px">Data / hora (observada)</label>
            <input id="datetime" name="datetime" type="text" placeholder="ex.: 2025-03-04 10:30 (opcional)">

            <div class="controls" style="justify-content:flex-start">
              <button type="button" class="btn" id="next-1">Pr√≥ximo: Local</button>
            </div>
          </fieldset>

          <!-- Step 2 -->
          <fieldset data-step="2" style="display:none">
            <label>Localiza√ß√£o</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button type="button" class="btn ghost" id="detect-location">Detectar minha posi√ß√£o</button>
              <button type="button" class="btn ghost" id="manual-pos-btn">Inserir manualmente</button>
            </div>

            <div id="map" aria-label="Mapa para escolher localiza√ß√£o"></div>

            <label for="address" style="margin-top:10px">Endere√ßo / refer√™ncia</label>
            <input id="address" name="address" type="text" placeholder="Ex.: Rua ABC, pr√≥ximo ao n√∫mero X">

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
              <div class="hint">Lat: <span id="lat">‚Äî</span> &nbsp; Lng: <span id="lng">‚Äî</span></div>
              <div class="controls" style="justify-content:flex-end">
                <button type="button" class="btn ghost" id="back-2">Voltar</button>
                <button type="button" class="btn" id="next-2">Pr√≥ximo: Fotos</button>
              </div>
            </div>
          </fieldset>

          <!-- Step 3 -->
          <fieldset data-step="3" style="display:none">
            <label for="photos">Fotos (at√© 6)</label>
            <input id="photos" type="file" accept="image/*" multiple>
            <div class="photos" id="photos-preview" aria-live="polite"></div>

            <div class="controls">
              <button type="button" class="btn ghost" id="back-3">Voltar</button>
              <button type="button" class="btn" id="next-3">Pr√≥ximo: Revisar</button>
            </div>
          </fieldset>

          <!-- Step 4 -->
          <fieldset data-step="4" style="display:none">
            <label>Revisar den√∫ncia</label>
            <div id="review-area" class="report-card" aria-live="polite"></div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
              <input id="anonymous" name="anonymous" type="checkbox"> <label for="anonymous" style="margin:0;font-weight:700">Enviar anonimamente (simula√ß√£o)</label>
            </div>

            <!-- Photos will be also appended to a hidden input as JSON to send via FormSubmit -->
            <input type="hidden" name="photos_data" id="photos-data">

            <div class="controls" style="justify-content:flex-start;margin-top:12px">
              <button type="button" class="btn ghost" id="back-4">Voltar</button>
              <button type="submit" class="btn" id="submit-report">Enviar simulada (salva local + envia por e‚Äëmail)</button>
            </div>
          </fieldset>
        </form>
      </div>

      <!-- RIGHT COLUMN: preview and saved -->
      <aside>
        <div class="card">
          <h3 style="margin:0 0 8px">Visualiza√ß√£o r√°pida</h3>
          <div class="report-card">
            <div style="display:flex;justify-content:space-between">
              <div><strong>Categoria:</strong> <span id="pv-category">‚Äî</span></div>
              <div id="pv-severity" style="color:#475569">‚Äî</div>
            </div>
            <div id="pv-desc" style="margin-top:8px;color:#475569">‚Äî</div>
            <div id="pv-photos" style="display:flex;gap:8px;margin-top:8px"></div>
          </div>
          <div style="margin-top:12px">
            <button class="btn" id="open-review">Salvar / Enviar simulado</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Den√∫ncias simuladas</h3>
          <div id="saved-list" class="saved-list" aria-live="polite"></div>
          <div style="margin-top:8px">
            <button class="btn ghost" id="clear-storage">Limpar todas (local)</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- bottom mobile step actions -->
  <div class="step-actions" id="mobile-actions" aria-hidden="true">
    <div id="mobile-step-label" style="font-weight:700;color:#334155">Passo</div>
    <div style="display:flex;gap:8px">
      <button class="btn ghost" id="mobile-back" aria-hidden="true">Voltar</button>
      <button class="btn" id="mobile-next" aria-hidden="true">Pr√≥ximo</button>
    </div>
  </div>

  <script>
    /* ===== State ===== */
    const state = { step: 1, lat: null, lng: null, photos: [], map: null, marker: null };

    /* ===== Elements ===== */
    const form = document.getElementById('report-form');
    const fieldsets = Array.from(form.querySelectorAll('fieldset[data-step]'));
    const pvCategory = document.getElementById('pv-category');
    const pvSeverity = document.getElementById('pv-severity');
    const pvDesc = document.getElementById('pv-desc');
    const pvPhotos = document.getElementById('pv-photos');
    const photosInput = document.getElementById('photos');
    const photosPreview = document.getElementById('photos-preview');
    const savedList = document.getElementById('saved-list');
    const reviewArea = document.getElementById('review-area');
    const photosDataInput = document.getElementById('photos-data');

    // navigation buttons
    const next1 = document.getElementById('next-1');
    const next2 = document.getElementById('next-2');
    const next3 = document.getElementById('next-3');
    const back2 = document.getElementById('back-2');
    const back3 = document.getElementById('back-3');
    const back4 = document.getElementById('back-4');

    const openReviewBtn = document.getElementById('open-review');
    const clearStorageBtn = document.getElementById('clear-storage');

    // map controls
    const detectBtn = document.getElementById('detect-location');
    const manualPosBtn = document.getElementById('manual-pos-btn');
    const latEl = document.getElementById('lat');
    const lngEl = document.getElementById('lng');
    const addressEl = document.getElementById('address');

    // mobile actions
    const mobileActions = document.getElementById('mobile-actions');
    const mobileBack = document.getElementById('mobile-back');
    const mobileNext = document.getElementById('mobile-next');
    const mobileLabel = document.getElementById('mobile-step-label');

    /* ===== Helpers ===== */
    function showStep(n){
      state.step = n;
      fieldsets.forEach(fs => fs.style.display = Number(fs.dataset.step) === n ? '' : 'none');
      updatePreview();
      updateMobileActions();
      // ensure map sizing when visible
      if(n === 2 && state.map) setTimeout(()=>state.map.invalidateSize(), 120);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updatePreview(){
      const cat = document.getElementById('category').value || '‚Äî';
      const sev = document.getElementById('severity').value || '‚Äî';
      const desc = document.getElementById('description').value || '‚Äî';
      pvCategory.textContent = cat;
      pvSeverity.textContent = sev;
      pvDesc.textContent = desc;
      pvPhotos.innerHTML = '';
      state.photos.slice(0,4).forEach(u => {
        const img = document.createElement('img'); img.src = u; img.className = 'photo-thumb'; img.alt = 'foto';
        pvPhotos.appendChild(img);
      });
    }

    function validateStep1(){
      const cat = document.getElementById('category').value;
      const sev = document.getElementById('severity').value;
      const desc = document.getElementById('description').value.trim();
      if(!cat || !sev || !desc){ alert('Preencha categoria, gravidade e descri√ß√£o.'); return false; }
      return true;
    }

    /* ===== Map (Leaflet) ===== */
    function initMapOnce(){
      if(state.map) return;
      const mapEl = document.getElementById('map');
      state.map = L.map(mapEl, { scrollWheelZoom: false }).setView([-23.55052, -46.633308], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(state.map);
      state.marker = L.marker([-23.55052, -46.633308], { draggable: true }).addTo(state.map);
      state.marker.on('dragend', function(e){
        const p = e.target.getLatLng(); state.lat = p.lat; state.lng = p.lng;
        latEl.textContent = state.lat.toFixed(6); lngEl.textContent = state.lng.toFixed(6);
      });
    }

    detectBtn.addEventListener('click', function(){
      if(!navigator.geolocation){ alert('Geolocaliza√ß√£o n√£o suportada neste navegador.'); return; }
      if(location.protocol !== 'https:' && location.hostname !== 'localhost'){ /* warn HTTPS requirement */
        if(!confirm('A detec√ß√£o de localiza√ß√£o funciona melhor em HTTPS. Deseja tentar mesmo assim?')) return;
      }
      detectBtn.textContent = 'Detectando‚Ä¶';
      navigator.geolocation.getCurrentPosition(function(pos){
        detectBtn.textContent = 'Detectar minha posi√ß√£o';
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        state.lat = lat; state.lng = lng;
        latEl.textContent = lat.toFixed(6); lngEl.textContent = lng.toFixed(6);
        if(!state.map) initMapOnce();
        state.map.setView([lat,lng], 16);
        state.marker.setLatLng([lat,lng]);
        addressEl.value = '';
      }, function(err){
        detectBtn.textContent = 'Detectar minha posi√ß√£o';
        alert('N√£o foi poss√≠vel obter a localiza√ß√£o: ' + (err.message || 'erro'));
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
    });

    manualPosBtn.addEventListener('click', function(){ addressEl.focus(); });

    /* ===== Photos handling ===== */
    photosInput.addEventListener('change', function(){
      const files = Array.from(this.files).slice(0,6);
      state.photos = [];
      photosPreview.innerHTML = '';
      if(!files.length) return;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e){
          const url = e.target.result;
          state.photos.push(url);
          const img = document.createElement('img'); img.src = url; img.className = 'photo-thumb'; img.alt = file.name;
          photosPreview.appendChild(img);
          updatePreview();
        };
        reader.readAsDataURL(file);
      });
    });

    /* ===== Steps navigation ===== */
    next1.addEventListener('click', function(){ if(validateStep1()){ initMapOnce(); showStep(2); }});
    back2.addEventListener('click', () => showStep(1));
    next2.addEventListener('click', () => showStep(3));
    back3.addEventListener('click', () => showStep(2));
    next3.addEventListener('click', function(){ populateReview(); showStep(4); });

    back4.addEventListener('click', () => showStep(3));

    // mobile action handlers
    function updateMobileActions(){
      if(window.innerWidth <= 720){
        mobileActions.setAttribute('aria-hidden','false');
        mobileActions.style.display = 'flex';
        mobileLabel.textContent = `Passo ${state.step} de 4`;
        // show appropriate action mapping
        mobileBack.hidden = state.step === 1;
        mobileNext.hidden = state.step === 4;
        mobileBack.removeAttribute('aria-hidden'); mobileNext.removeAttribute('aria-hidden');
      } else {
        mobileActions.style.display = 'none';
        mobileActions.setAttribute('aria-hidden','true');
      }
    }

    mobileBack.addEventListener('click', function(){
      if(state.step > 1) showStep(state.step - 1);
    });
    mobileNext.addEventListener('click', function(){
      if(state.step === 1){ if(validateStep1()) showStep(2); }
      else if(state.step === 2) showStep(3);
      else if(state.step === 3) { populateReview(); showStep(4); }
    });

    window.addEventListener('resize', updateMobileActions);

    /* ===== Review and storage ===== */
    function populateReview(){
      const cat = document.getElementById('category').value || '‚Äî';
      const sev = document.getElementById('severity').value || '‚Äî';
      const desc = document.getElementById('description').value || '‚Äî';
      const addr = document.getElementById('address').value || '‚Äî';
      const dt = document.getElementById('datetime').value || '‚Äî';
      const photosHtml = state.photos.map(u => `<img src="${u}" style="width:96px;height:96px;object-fit:cover;border-radius:8px">`).join(' ');
      reviewArea.innerHTML = `
        <div><strong>Categoria:</strong> ${escapeHtml(cat)}</div>
        <div><strong>Gravidade:</strong> ${escapeHtml(sev)}</div>
        <div style="margin-top:8px;"><strong>Descri√ß√£o:</strong><div style="margin-top:6px">${escapeHtml(desc)}</div></div>
        <div style="margin-top:8px;"><strong>Local:</strong> ${escapeHtml(addr)} <small style="display:block;color:#6b7280">Lat: ${state.lat||'‚Äî'} Lng: ${state.lng||'‚Äî'}</small></div>
        <div style="margin-top:8px;"><strong>Data/Hora observada:</strong> ${escapeHtml(dt)}</div>
        <div style="margin-top:12px;"><strong>Fotos:</strong><div style="display:flex;gap:8px;margin-top:8px">${photosHtml || '<span style="color:#6b7280">Sem fotos</span>'}</div></div>
      `;
      // prepare photos JSON to send to FormSubmit (note: large payloads can be heavy)
      photosDataInput.value = JSON.stringify(state.photos);
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // localStorage helpers
    function getReports(){ try{ return JSON.parse(localStorage.getItem('limpae_reports')||'[]'); }catch(e){ return []; } }
    function saveReport(r){ const arr = getReports(); arr.unshift(r); localStorage.setItem('limpae_reports', JSON.stringify(arr.slice(0,200))); }
    function populateSavedList(){
      const arr = getReports();
      savedList.innerHTML = '';
      if(!arr.length){ savedList.innerHTML = '<div style="color:#6b7280">Nenhuma den√∫ncia simulada ainda.</div>'; return; }
      arr.forEach(item => {
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
        el.style.padding='8px'; el.style.borderRadius='8px'; el.style.border='1px solid rgba(2,6,23,0.04)'; el.style.background='#fff';
        el.innerHTML = `<div style="display:flex;gap:10px;align-items:center;min-width:0">
          <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center">${item.photos && item.photos[0] ? `<img src="${item.photos[0]}" style="width:56px;height:56px;object-fit:cover">` : 'üóëÔ∏è'}</div>
          <div style="min-width:0">
            <div style="font-weight:700;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:160px">${escapeHtml(item.category)} ¬∑ ${escapeHtml(item.severity)}</div>
            <div style="color:#6b7280;font-size:13px;max-width:220px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden">${escapeHtml(item.description)}</div>
            <div style="color:#6b7280;font-size:12px;margin-top:4px">${new Date(item.createdAt).toLocaleString()}</div>
          </div>
        </div>
        <div><button data-id="${item.id}" class="remove-btn" style="background:transparent;border:0;color:#ef4444;font-weight:700;cursor:pointer">Remover</button></div>`;
        savedList.appendChild(el);
      });
      // attach remove handlers
      Array.from(savedList.querySelectorAll('.remove-btn')).forEach(btn => {
        btn.addEventListener('click', function(){
          const id = this.dataset.id;
          const arr = getReports().filter(x => x.id !== id);
          localStorage.setItem('limpae_reports', JSON.stringify(arr));
          populateSavedList();
        });
      });
    }

    clearStorageBtn.addEventListener('click', function(){
      if(confirm('Limpar todas as den√∫ncias simuladas armazenadas localmente?')){ localStorage.removeItem('limpae_reports'); populateSavedList(); }
    });

    /* ===== Form submit handling =====
       - The form has action to FormSubmit (your endpoint). When user submits, the browser will POST to FormSubmit
       - We also intercept submit to save a local copy and attach photos_data (base64) into a hidden field
       - Note: sending large base64 images via email may increase size; prefer small images in demo
    */
    form.addEventListener('submit', function(ev){
      // first validate step 1 required fields before allowing submit
      if(!validateStep1()){ ev.preventDefault(); showStep(1); return; }

      // populate photos_data already handled in populateReview. Ensure it's up-to-date:
      populateReview();

      // Save local copy (simulate)
      const report = {
        id: 'r' + Date.now(),
        category: document.getElementById('category').value,
        severity: document.getElementById('severity').value,
        description: document.getElementById('description').value,
        datetime: document.getElementById('datetime').value,
        address: document.getElementById('address').value,
        lat: state.lat,
        lng: state.lng,
        photos: state.photos.slice(),
        anonymous: document.getElementById('anonymous').checked,
        createdAt: new Date().toISOString()
      };
      saveReport(report);
      populateSavedList();

      // Allow form to submit to FormSubmit ‚Äî open in new tab for nicer UX
      // To open result in new tab while still POSTing, create a temporary form and submit it with target="_blank"
      ev.preventDefault(); // prevent default so we can do custom submit
      const tmp = document.createElement('form');
      tmp.method = 'POST';
      tmp.action = 'https://formsubmit.co/el/kazoho';
      tmp.target = '_blank';
      tmp.style.display = 'none';

      // copy relevant fields (text) to tmp form
      const fields = {
        _subject: 'Nova den√∫ncia simulada ‚Äî Limpa√™',
        _captcha: 'false',
        source: 'limpae-prototipo-escolar',
        category: report.category,
        severity: report.severity,
        description: report.description,
        datetime: report.datetime,
        address: report.address,
        lat: report.lat,
        lng: report.lng,
        anonymous: report.anonymous ? 'Sim' : 'N√£o',
        photos_data: JSON.stringify(report.photos)
      };
      for(const k in fields){
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = k;
        inp.value = fields[k] == null ? '' : fields[k];
        tmp.appendChild(inp);
      }
      document.body.appendChild(tmp);
      tmp.submit();
      setTimeout(()=>{ tmp.remove(); }, 600);

      // show a small thanks overlay locally
      showThanksLocal();
      // reset form and go to step 1
      form.reset();
      state.photos = []; photosPreview.innerHTML = ''; updatePreview();
      state.lat = null; state.lng = null; latEl.textContent = '‚Äî'; lngEl.textContent = '‚Äî';
      showStep(1);
    });

    function showThanksLocal(){
      const box = document.createElement('div');
      box.style.position = 'fixed'; box.style.left = '50%'; box.style.top = '50%';
      box.style.transform = 'translate(-50%,-50%)'; box.style.zIndex = 6000;
      box.style.background = '#fff'; box.style.padding = '20px'; box.style.borderRadius = '12px';
      box.style.boxShadow = '0 18px 40px rgba(2,6,23,0.2)';
      box.innerHTML = `<h3 style="margin:0 0 8px;color:${'#14532d'}">Den√∫ncia simulada enviada</h3>
        <p style="margin:0 0 12px;color:#374151">A den√∫ncia foi salva localmente e uma solicita√ß√£o de demonstra√ß√£o foi aberta em nova aba.</p>
        <div style="text-align:right"><button id="close-thanks" style="background:linear-gradient(90deg,var(--green-600),var(--green-500));color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Fechar</button></div>`;
      document.body.appendChild(box);
      document.body.style.overflow = 'hidden';
      document.getElementById('close-thanks').addEventListener('click', function(){
        document.body.style.overflow = '';
        box.remove();
      });
    }

    /* ===== UI wiring ===== */
    // preview update on input
    ['category','severity','description','address','datetime'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', updatePreview);
    });

    // open review from preview
    openReviewBtn.addEventListener('click', function(){
      if(!validateStep1()){ showStep(1); return; }
      populateReview();
      showStep(4);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // initial map lazy init when user clicks to step 2
    // we already call initMapOnce when entering step 2 via next1 handler
    // but guard in case user jumps directly to step 2 (e.g., using url)
    // ensure map resizes on visibility change
    const observer = new MutationObserver(function(){
      if(state.map) state.map.invalidateSize();
    });
    observer.observe(document.getElementById('left-card'), { attributes:true, childList:true, subtree:true });

    // initial state
    showStep(1);
    populateSavedList();
    updatePreview();
    updateMobileActions();
  </script>
</body>
</html>
